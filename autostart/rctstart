#!/bin/sh
### BEGIN INIT INFO
# Provides: rctstart
# Required-Start: $portmap $time $remote_fs 
# Required-Stop:
# Default-Start: 2 3 4 5
# Default-Stop: 0 1 6
# Short-Description: Start radio collar tracker payload on switch
### END INIT INFO
# setup here
log="/home/debian/rct.log"
echo "$(timestamp): Starting..." >> $log
switch_num=30

switch_dir="/sys/class/gpio/gpio$switch_num"
timestamp(){
	date
}

# check for autostart file!
if [ ! -e "/home/debian/autostart" ]
	then
		echo "$(timestamp): Autostart not found!" >> $log
	exit
fi

echo $switch_num > /sys/class/gpio/export
stateVal="startWait"
while true
do
	case $stateVal in
		"startWait" )
		# State 1 - wait for start
		switchVal=`cat $switch_dir/value`
			until [ "$switchVal" = "0" ]; do
				sleep 3
				switchVal=`cat $switch_dir/value`
			done
			echo "$(timestamp): Received start signal!" >> $log
			stateVal="startgo"
			;;
		"startgo" )
		# State 2 - go for start, initialize
			/home/debian/radio_collar_tracker/sdr_starter.sh &
			sdr_starter_pid=$!
			echo "$(timestamp): Started program!" >> $log
			runNum=`/home/pi/radio_collar_tracker/getRunNum.py -e /home/pi/rct/`
			echo "$(timestamp): $runNum" >> $log
			stateVal="endWait"
			;;
		"endWait" )
			switchVal=`cat $switch_dir/value`
			until [ "$switchVal" = "1" ]; do
				sleep 3
				switchVal=`cat $switch_dir/value`
			done
			echo "$(timestamp): Received stop signal!" >> $log
			stateVal="endgo"
			;;
		"endgo" )
			/bin/kill -s TERM $sdr_starter_pid
			# killall ct -s INT
			echo "$(timestamp): Ended program!" >> $log
			echo "$(timestamp): Begin dmesg dump" >> $log
			dmesg >> $log
			echo "$(timestamp): end dmesg dump" >> $log
			stateVal="startWait"
			;;
	esac
done
